name: Build and Push Docker Images to ECR

on:
  push:
    branches: [ "*" ]
    tags: [ "*" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed to fetch full history for diff

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, create ECR repo if needed, and push Docker images
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          # List commits for debugging
          echo "Previous SHA: ${{ github.event.before }}"
          echo "Current SHA: ${{ github.sha }}"

          BEFORE="${{ github.event.before }}"
          if [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
             echo "New branch or tag detected. Determining changes against default branch."
             # Use 3-dot diff to find changes reachable from HEAD but not from origin/main
             changed_files=$(git diff --name-only origin/main...HEAD)
          else
             # Get changed files between last and current commit
             changed_files=$(git diff --name-only "$BEFORE" "${{ github.sha }}")
          fi

          echo "Changed files:"
          echo "$changed_files"

          for dir in */ ; do
            dir=${dir%/}
            # Check if any changed files in this directory
            if echo "$changed_files" | grep -q "^$dir/"; then
              echo "Detected changes in $dir - processing..."

              IMAGE_NAME="$dir"
              ECR_REPO="$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$IMAGE_NAME"

              # Check if ECR repo exists, create if not
              if ! aws ecr describe-repositories --repository-names "$IMAGE_NAME" > /dev/null 2>&1; then
                echo "ECR repository $IMAGE_NAME does not exist. Creating..."
                aws ecr create-repository --repository-name "$IMAGE_NAME" > /dev/null || true
              else
                echo "ECR repository $IMAGE_NAME already exists."
              fi

              # Build and push image
              TAG="${GITHUB_SHA::7}"
              docker build -f "$dir/Dockerfile" -t "$ECR_REPO:$TAG" .
              docker push "$ECR_REPO:$TAG"
              docker tag "$ECR_REPO:$TAG" "$ECR_REPO:latest"
              docker push "$ECR_REPO:latest"
            else
              echo "No changes in $dir, skipping build."
            fi
          done
